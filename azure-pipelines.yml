name: Volley Management-3.0$(Rev:.r)

variables:
  docker_repository_name: sdiachen/volleymanagement

trigger:
- master

stages:
  - stage: build
    displayName: 'Build'
    jobs:
      - job: container_build
        displayName: Build Container
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - bash: ./build/az-pipe-get-pr-vars.sh
            displayName: 'Set docker tag'
          - task: Docker@2
            displayName: Docker Build and Push
            inputs:
              containerRegistry: 'VM on Personal DockerHub'
              repository: $(docker_repository_name)
              command: 'buildAndPush'
              Dockerfile: './src/VolleyManagement.API/Dockerfile'
              buildContext: './src'
              tags: $(image_tag)
  - stage: deploy_prod
    displayName: 'Deploy Production'
    dependsOn: build
    condition: and(succeeded(), eq(0, variables['System.PullRequest.PullRequestId']), eq(variables['Build.SourceBranchName'], 'master'))
    jobs:
      - job: deploy_app_service
        displayName: Deploy App Service
        steps:
          - bash: ./build/az-pipe-get-pr-vars.sh
            displayName: 'Set docker tag'